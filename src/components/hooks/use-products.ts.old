import { useState, useEffect, useContext } from 'react';
import { ApiServiceContext } from '../api-service-context/api-service-context';
import type { IProduct, TApiProductFilters } from '../../types/product';

type UseProductsResult = {
    data: IProduct[] | undefined;
    isLoading: boolean;
    error: Error | null;
};

export const useProducts = (filters?: TApiProductFilters): UseProductsResult => {
    const api = useContext(ApiServiceContext);
    if (!api) throw new Error('ApiService not provided');

    // Если есть RTK Query hook (т.е. реальный API), используем его
    if (api.useGetProductsQuery) {
        const { data, isLoading, error } = api.useGetProductsQuery(filters);
        return { data, isLoading, error: error as any || null };
    }

    // Фейковый API через промис
    const [data, setData] = useState<IProduct[] | undefined>(undefined);
    const [isLoading, setLoading] = useState(true);
    const [error, setError] = useState<Error | null>(null);

    useEffect(() => {
        let cancelled = false;

        api.getProducts(filters)
            .then(result => {
                if (!cancelled) {
                    setData(result);
                    setLoading(false);
                }
            })
            .catch(err => {
                if (!cancelled) {
                    setError(err as Error);
                    setLoading(false);
                }
            });

        return () => { cancelled = true; };
    }, [api, filters]);

    return { data, isLoading, error };
};
